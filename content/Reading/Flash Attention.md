[2205.14135.pdf (arxiv.org)](https://arxiv.org/pdf/2205.14135.pdf)

## Abstract
Transformers are **slow and memory-hungry on long sequences**, since the **time and memory complexity of self-attention are quadratic in sequence length**. Approximate attention methods have attempted to address this problem by trading off model quality to reduce the compute complexity, but often do not achieve wall-clock speedup. We argue that a **missing principle is making attention algorithms IO-awar**e‚Äîaccounting for reads and writes between levels of GPU memory. We propose **FlashAttention, an IO-aware exact attention algorithm** that uses tiling to reduce the number of memory reads/writes between GPU high bandwidth memory (HBM) and GPU on-chip SRAM. We analyze the IO complexity of FlashAttention, showing that it **requires fewer HBM accesses than standard attention**, and is optimal for a range of SRAM sizes. We also extend FlashAttention to block-sparse attention, yielding an approximate attention algorithm that is faster than any existing approximate attention method. FlashAttention trains Transformers faster than existing baselines: 15% end-to-end wall-clock speedup on BERT-large (seq. length 512) compared to the MLPerf 1.1 training speed record, 3√ó speedup on GPT-2 (seq. length 1K), and 2.4√ó speedup on long-range arena (seq. length 1K-4K). **FlashAttention and block-sparse FlashAttention enable longer context in Transformers,** yielding higher quality models (0.7 better perplexity on GPT-2 and 6.4 points of lift on long-document classification) and entirely new capabilities: the first Transformers to achieve better-than-chance performance on the Path-X challenge (seq. length 16K, 61.4% accuracy) and Path-256 (seq. length 64K, 63.1% accuracy).

## Core takeaways
- FlashAttention does not read and write the large ùëÅ √ó ùëÅ attention matrix to HBM, resulting in an 7.6√ó speedup on the attention computation
- GPUs, compute speed has out-paced memory speed [61, 62, 63], and most operations in Transformers are bottlenecked by memory accesses
- FlashAttention, a new attention algorithm that computes exact attention with far fewer memory accesses
- We implement FlashAttention in CUDA to achieve fine-grained control over memory access and fuse all the attention operations into one GPU kernel
- Even with the increased FLOPs due to recomputation, our algorithm both runs faster (up to 7.6x on GPT-2 [67], Figure 1 right) and uses less memory‚Äî**linear in sequence length**‚Äîthan standard attention, thanks to the massively reduced amount of HBM access
- FlashAttention is up to 3√ó faster than the standard attention implementation across common sequence lengths from 128 to 2K and scales up to 64K. Up to sequence length of 512, FlashAttention is both faster and more memory-efficient than any existing attention method, whereas for sequence length beyond 1K, some approximate attention methods (e.g., Linformer) start to become faster. On the other hand, block-sparse FlashAttention is faster than all existing approximate attention methods that we know of.
- Long Document Classification. Training Transformers with longer sequences with FlashAttention improves performance on the MIMIC-III [47] and ECtHR [6, 7] datasets
- Path-X and Path-256. The Path-X and Path-256 benchmarks are challenging tasks from the long-range arena benchmark designed to test long context. The task is to classify whether two points in a black and white 128√ó128 (or 256√ó256) image have a path connecting them, and the images are fed to the transformer one pixel at a time. In prior work, all transformer models have either run out of memory, or only achieved random performance [80]. There has been a search for alternative architectures that can model such long context [37]. We present here the first result of Transformer models being able to solve Path-X and Path-256 (Table 6). We pretrain a transformer on Path-64, and then transfer to Path-X by spatially interpolating the positional embeddings. FlashAttention achieves 61.4 accuracy on Path-X. Additionally, block-sparse FlashAttention enables the Transformers to scale to sequence length 64K, achieving 63.1 accuracy4 on Path-256

![[flash-attention-scaling.png]]

## My Take aways
- Flash attention is very low level and written in cuda and so is nvidia specific.
- Memory now scales linearly with context length BUT runtime cost is "sub-quadratic". E.g. better but still a key problem. So will need to be mindful of context length.

# FlashAttention 2
## Abstract
Scaling Transformers to longer sequence lengths has been a major problem in the last several years, promising to improve performance in language modeling and high-resolution image understanding, as well as to unlock new applications in code, audio, and video generation. The attention layer is the main bottleneck in scaling to longer sequences, as its runtime and memory increase quadratically in the sequence length. FlashAttention [5] exploits the asymmetric GPU memory hierarchy to bring significant memory saving (linear instead of quadratic) and runtime speedup (2-4√ó compared to optimized baselines), with no approximation. However, FlashAttention is still not nearly as fast as optimized matrix-multiply (GEMM) operations, reaching only 25-40% of the theoretical maximum FLOPs/s. We observe that the inefficiency is due to suboptimal work partitioning between different thread blocks and warps on the GPU, causing either low-occupancy or unnecessary shared memory reads/writes. We propose FlashAttention-2, with better work partitioning to address these issues. In particular, we (1) tweak the algorithm to reduce the number of non-matmul FLOPs (2) parallelize the attention computation, even for a single head, across different thread blocks to increase occupancy, and (3) within each thread block, distribute the work between warps to reduce communication through shared memory. These yield around 2√ó speedup compared to FlashAttention, reaching 50-73% of the theoretical maximum FLOPs/s on A100 and getting close to the efficiency of GEMM operations. We empirically validate that when used end-to-end to train GPT-style models, FlashAttention-2 reaches training speed of up to 225 TFLOPs/s per A100 GPU (72% model FLOPs utilization).1

## Exerpts
Just within the last year, there have been several language models with much longer context than before: GPT-4 [12] with context length 32k, MosaicML‚Äôs MPT with context length 65k, and Anthropic‚Äôs Claude with context length 100k. Emerging use cases such as long document querying and story writing have demonstrated a need for models with such long context.


## My Takeaways
- FlashAttention-2 tweaks the algorithm to 2x speed up the computation time of flashattention while keeping its memory benefits.